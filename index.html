<!DOCTYPE html>
<html lang="pt-BR">
<head>
  
<link rel="manifest" href="manifest.json">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Placas</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f9; text-align: center; padding: 20px; margin:0; }
  h1 { color: #333; margin-top: 50px; }
  input, select, button { padding: 10px; margin: 8px; width: 90%; max-width: 300px; border: 1px solid #ccc; border-radius: 5px; }
  button { color: white; border: none; cursor: pointer; background: #4CAF50; }
  .entrada { background: #4CAF50; }
  .saida { background: #f44336; }
  .card { background: white; padding: 15px; margin-top: 15px; border-radius: 8px; box-shadow: 0px 2px 6px rgba(0,0,0,0.2); text-align: left; }
  .lista { margin-top:20px; }
  .item { border-bottom:1px solid #ddd; padding:8px; text-align:left; }
  #historicoContainer, #cadastroContainer, #inicioContainer { display:none; }
  .horaEntrada { color: green; font-weight: bold; }
  .horaSaida { color: red; font-weight: bold; }
  #mensagem { color: green; font-weight: bold; margin-top: 10px; }
  table { width: 100%; max-width: 600px; margin: 20px auto; border-collapse: collapse; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #f2f2f2; }
  .menu-btn { position: fixed; top: 10px; left: 10px; font-size: 30px; cursor: pointer; z-index: 1001; }
  .menu-content { position: fixed; top: 0; left: -250px; width: 250px; height: 100%; background: #333; color: white; overflow-x: hidden; transition: 0.3s; padding-top: 60px; z-index: 1000; }
  .menu-content a { padding: 10px 20px; text-decoration: none; display: block; color: white; font-weight: bold; }
  .menu-content a:hover { background: #575757; }
  .menu-open { left: 0; }

  /* MODAL POP-UP */
  #overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 1001;
    display: none;
  }

  #popupCard {
    position: fixed;
    top: 15%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 25px 20px 20px 20px;
    width: 90%;
    max-width: 400px;
    border-radius: 10px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    z-index: 1002;
    display: none;
  }

  #popupCard .fecharBtn {
    position: absolute;
    top: -10px;
    right: -50px;
    background: none;
    border: none;
    font-size: 26px;
    font-weight: bold;
    cursor: pointer;
    color: #f44336;
  }

  #exportBtn { background-color: #2196F3; }
</style>
</head>
<body>

<div class="menu-btn" onclick="toggleMenu()">&#9776;</div>

<div id="menu" class="menu-content">
  <a href="#" onclick="mostrarPagina('inicioContainer'); toggleMenu();">Início</a>
  <a href="#" onclick="mostrarPagina('cadastroContainer'); toggleMenu();">Cadastro</a>
  <a href="#" onclick="mostrarPagina('historicoContainer'); toggleMenu();">Histórico</a>
  <a href="#" onclick="limparTudo(); toggleMenu();">Limpar Dados</a>
</div>

<!-- OVERLAY -->
<div id="overlay" onclick="fecharPopup()"></div>

<!-- POP-UP CARD -->
<div id="popupCard">
  <button class="fecharBtn" onclick="fecharPopup()">×</button>
  <div id="popupConteudo"></div>
</div>

<!-- PÁGINA INICIAL -->
<div id="inicioContainer">
  <h1>Controle de Placas</h1>
  <p>Digite a placa para verificar:</p>
  <input type="text" id="placaInput" placeholder="Ex: ABC1234" oninput="this.value = this.value.toUpperCase()">
  <button onclick="verificarPlaca()">Verificar</button>

  <div id="mensagem"></div>

  <h2>Placas em andamento</h2>
  <table>
    <thead>
      <tr>
        <th>Placa</th>
        <th>Nome</th>
        <th>Entrada</th>
        <th>Saída</th>
      </tr>
    </thead>
    <tbody id="tabelaAndamento"></tbody>
  </table>
</div>

<!-- PÁGINA CADASTRO -->
<div id="cadastroContainer">
  <h2>Cadastros</h2>
  <div id="listaCadastros" class="lista"></div>
</div>

<!-- PÁGINA HISTÓRICO -->
<div id="historicoContainer">
  <h2>Histórico</h2>
  <label for="dataFiltro">Selecionar data:</label>
  <input type="date" id="dataFiltro">
  <button onclick="filtrarHistorico()">Buscar</button>
  <button id="exportBtn" onclick="exportarCSV()">Exportar CSV</button>
  <div id="listaHistorico" class="lista"></div>
</div>

<script>
let bancoCadastros = JSON.parse(localStorage.getItem("bancoCadastros")) || [];
let bancoHistorico = JSON.parse(localStorage.getItem("bancoHistorico")) || [];

// FUNÇÕES GERAIS
function salvarBanco() {
  localStorage.setItem("bancoCadastros", JSON.stringify(bancoCadastros));
  localStorage.setItem("bancoHistorico", JSON.stringify(bancoHistorico));
  atualizarCadastros();
  atualizarTabelaAndamento();
}

function atualizarCadastros() {
  const listaDiv = document.getElementById("listaCadastros");
  listaDiv.innerHTML = "";
  bancoCadastros.forEach(item => {
    listaDiv.innerHTML += `<div class="item"><b>${item.placa}</b> - ${item.nome} [${item.tipo}] - RG/CPF: ${item.rgcpf}</div>`;
  });
}

function formatarData(d) {
  const dia = String(d.getDate()).padStart(2,'0');
  const mes = String(d.getMonth()+1).padStart(2,'0');
  const ano = d.getFullYear();
  return `${dia}/${mes}/${ano}`;
}

function converterDataInput(input) {
  const parts = input.split('-'); // YYYY-MM-DD
  return `${parts[2]}/${parts[1]}/${parts[0]}`;
}

// FILTRAR HISTÓRICO POR DATA
function filtrarHistorico() {
  const input = document.getElementById("dataFiltro").value;
  const dataFiltro = input ? converterDataInput(input) : formatarData(new Date());
  const listaDiv = document.getElementById("listaHistorico");
  listaDiv.innerHTML = "";

  bancoHistorico.filter(item => item.data === dataFiltro).forEach(item => {
    let corStatus = item.status === "Em andamento" ? "red" : (item.status === "Finalizado" ? "green" : "black");
    listaDiv.innerHTML += `
      <div class="item">
        <b>${item.placa}</b> - ${item.nome} [${item.tipo}] - RG/CPF: ${item.rgcpf} <br>
        Data: ${item.data} <br>
        Status: <span style="color:${corStatus}">${item.status}</span> <br>
        Entrada: <span class="horaEntrada">${item.horarioEntrada || "-"}</span> | 
        Saída: <span class="horaSaida">${item.horarioSaida || "-"}</span>
      </div>
    `;
  });
}

// EXPORTAR CSV
function exportarCSV() {
  const dataFiltro = document.getElementById("dataFiltro").value;
  const dataTexto = dataFiltro ? converterDataInput(dataFiltro) : formatarData(new Date());
  const filtered = bancoHistorico.filter(item => item.data === dataTexto);
  if(filtered.length === 0){ alert("Nenhum dado para exportar."); return; }

  let csv = "Placa,Nome,Tipo,RG/CPF,Data,Status,Entrada,Saída\n";
  filtered.forEach(item => {
    csv += `${item.placa},${item.nome},${item.tipo},${item.rgcpf},${item.data},${item.status},${item.horarioEntrada || '-'},${item.horarioSaida || '-'}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `historico-${dataTexto}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  alert("Exportado com sucesso!");
}

// TABELA ANDAMENTO
function atualizarTabelaAndamento() {
  const tbody = document.getElementById("tabelaAndamento");
  tbody.innerHTML = "";
  bancoHistorico.filter(h => h.status === "Em andamento").forEach(h => {
    tbody.innerHTML += `
      <tr>
        <td>${h.placa}</td>
        <td>${h.nome}</td>
        <td class="horaEntrada">${h.horarioEntrada}</td>
        <td><button class="saida" onclick="marcarSaida('${h.placa}')">Saída</button></td>
      </tr>
    `;
  });
}

// MENU
function toggleMenu() { document.getElementById("menu").classList.toggle("menu-open"); }
function mostrarPagina(paginaId) {
  document.getElementById("inicioContainer").style.display = "none";
  document.getElementById("cadastroContainer").style.display = "none";
  document.getElementById("historicoContainer").style.display = "none";
  document.getElementById(paginaId).style.display = "block";

  if(paginaId==='historicoContainer' && !document.getElementById("dataFiltro").value){
    const hoje = new Date();
    document.getElementById("dataFiltro").value = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}-${String(hoje.getDate()).padStart(2,'0')}`;
    filtrarHistorico();
  }
}

// POP-UP CARD
function mostrarPopup(conteudo) {
  document.getElementById("popupConteudo").innerHTML = conteudo;
  document.getElementById("overlay").style.display = "block";
  document.getElementById("popupCard").style.display = "block";
}
function fecharPopup() {
  document.getElementById("overlay").style.display = "none";
  document.getElementById("popupCard").style.display = "none";
}

// ENTRADA / SAÍDA
function verificarPlaca() {
  const placaInput = document.getElementById("placaInput");
  const placa = placaInput.value.toUpperCase();
  placaInput.value = placa;
  const mensagemDiv = document.getElementById("mensagem");
  mensagemDiv.innerHTML = "";

  const registro = bancoCadastros.find(item => item.placa === placa);
  if (registro) {
    const ultimoHistorico = [...bancoHistorico].reverse().find(h => h.placa === placa);
    const statusAtual = ultimoHistorico ? ultimoHistorico.status : "-";
    const corStatus = statusAtual === "Em andamento" ? "red" : (statusAtual === "Finalizado" ? "green" : "black");

    mostrarPopup(`
      <h3>Placa encontrada ✅</h3>
      <p><b>Placa:</b> <input type="text" id="popupPlacaInput" value="${placa}" oninput="this.value = this.value.toUpperCase()"></p>
      <p><b>Nome:</b> ${registro.nome}</p>
      <p><b>Tipo:</b> ${registro.tipo}</p>
      <p><b>RG/CPF:</b> ${registro.rgcpf}</p>
      <p><b>Status:</b> <span id="statusDisplay" style="color:${corStatus}">${statusAtual}</span></p>
      <button class="entrada" onclick="marcarEntrada('${placa}')">Entrada</button>
      <button class="saida" onclick="marcarSaida('${placa}')">Saída</button>
    `);
  } else {
    mostrarPopup(`
      <h3>Placa não registrada ⚠️</h3>
      <p><b>Placa:</b> <input type="text" id="popupPlacaInput" value="${placa}" oninput="this.value = this.value.toUpperCase()"></p>
      <p>Preencha os dados abaixo para entrada:</p>
      <input type="text" id="nomeInput" placeholder="Nome">
      <input type="text" id="rgcpfInput" placeholder="RG/CPF">
      <select id="tipoInput">
        <option value="" disabled selected>Tipo:</option>
        <option value="Despacho">Despacho</option>
        <option value="Retiro">Retiro</option>
      </select>
      <button class="entrada" onclick="entradaNovaPlaca(document.getElementById('popupPlacaInput').value)">Entrada</button>
    `);
  }
}

// ENTRADA E SAÍDA CONTINUAM IGUAIS
function entradaNovaPlaca(placa) {
  const nome = document.getElementById("nomeInput").value;
  const rgcpf = document.getElementById("rgcpfInput").value;
  const tipo = document.getElementById("tipoInput").value;
  if (!nome || !rgcpf || !tipo || !placa) { alert("Preencha todos os campos antes de registrar!"); return; }

  const hoje = formatarData(new Date());
  bancoCadastros.push({ nome, placa, rgcpf, tipo });
  bancoHistorico.push({
    nome, placa, rgcpf, tipo,
    status: "Em andamento",
    data: hoje,
    horarioEntrada: new Date().toLocaleTimeString(),
    horarioSaida: ""
  });

  salvarBanco();
  fecharPopup();
  alert("Entrada registrada com sucesso! ✅");
}

function marcarEntrada(placa) {
  const ultimoHistorico = [...bancoHistorico].reverse().find(h => h.placa === placa && h.status === "Em andamento");
  if (ultimoHistorico) { alert("Essa placa já está em andamento!"); return; }

  const cadastro = bancoCadastros.find(item => item.placa === placa);
  if (!cadastro) return;

  const hoje = formatarData(new Date());
  bancoHistorico.push({
    nome: cadastro.nome,
    placa: cadastro.placa,
    rgcpf: cadastro.rgcpf,
    tipo: cadastro.tipo,
    status: "Em andamento",
    data: hoje,
    horarioEntrada: new Date().toLocaleTimeString(),
    horarioSaida: ""
  });

  salvarBanco();
  const statusSpan = document.getElementById("statusDisplay");
  if (statusSpan) { statusSpan.innerText = "Em andamento"; statusSpan.style.color = "red"; }
  


  fecharPopup();
}

function marcarSaida(placa) {
  const ultimoHistorico = [...bancoHistorico].reverse().find(h => h.placa === placa && h.status === "Em andamento");
  if (!ultimoHistorico) return;

  ultimoHistorico.status = "Finalizado";
  ultimoHistorico.horarioSaida = new Date().toLocaleTimeString();
  salvarBanco();

  const mensagemDiv = document.getElementById("mensagem");
  mensagemDiv.innerHTML = `Saída registrada com sucesso! ✅`;
  setTimeout(() => { mensagemDiv.innerHTML = ""; }, 5000);

  fecharPopup();
  document.getElementById("placaInput").value = "";
}

// LIMPAR DADOS
function limparTudo() {
  if(confirm("Deseja realmente limpar todos os dados?")) {
    localStorage.removeItem("bancoCadastros");
    localStorage.removeItem("bancoHistorico");
    bancoCadastros = [];
    bancoHistorico = [];
    salvarBanco();
    fecharPopup();
    document.getElementById("mensagem").innerHTML = "";
    alert("Todos os dados foram limpos!");
  }
}

// Inicializar
mostrarPagina('inicioContainer');
salvarBanco();

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js')
    .then(()=>console.log('Service Worker registrado!'))
    .catch(err=>console.log('Erro SW:',err));
}
</script>







</body>
</html>
