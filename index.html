<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="manifest" href="manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Placas</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f9; text-align: center; padding: 20px; margin:0; }
  h1 { color: #333; margin-top: 50px; }
  input, select, button { padding: 10px; margin: 8px; width: 90%; max-width: 300px; border: 1px solid #ccc; border-radius: 5px; }
  button { color: white; border: none; cursor: pointer; background: #4CAF50; }
  .entrada { background: #4CAF50; }
  .saida { background: #f44336; }
  .card { background: white; padding: 15px; margin-top: 15px; border-radius: 8px; box-shadow: 0px 2px 6px rgba(0,0,0,0.2); text-align: left; }
  .lista { margin-top:20px; }
  .item { border-bottom:1px solid #ddd; padding:8px; text-align:left; }
  #historicoContainer, #cadastroContainer, #inicioContainer { display:none; }
  .horaEntrada { color: green; font-weight: bold; }
  .horaSaida { color: red; font-weight: bold; }
  #mensagem { color: green; font-weight: bold; margin-top: 10px; }
  table { width: 100%; max-width: 600px; margin: 20px auto; border-collapse: collapse; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #f2f2f2; }
  .menu-btn { position: fixed; top: 10px; left: 10px; font-size: 30px; cursor: pointer; z-index: 1001; }
  .menu-content { position: fixed; top: 0; left: -250px; width: 250px; height: 100%; background: #333; color: white; overflow-x: hidden; transition: 0.3s; padding-top: 60px; z-index: 1000; }
  .menu-content a { padding: 10px 20px; text-decoration: none; display: block; color: white; font-weight: bold; }
  .menu-content a:hover { background: #575757; }
  .menu-open { left: 0; }
  #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1001; display: none; }
  #popupCard { position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: white; padding: 25px 20px 20px 20px; width: 90%; max-width: 400px; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); z-index: 1002; display: none; }
  #popupCard .fecharBtn { position: absolute; top: -10px; right: -10px; background: none; border: none; font-size: 26px; font-weight: bold; cursor: pointer; color: #f44336; }
  #exportBtn { background-color: #2196F3; }
</style>
</head>
<body>

<div class="menu-btn" onclick="toggleMenu()">&#9776;</div>

<div id="menu" class="menu-content">
  <a href="#" onclick="mostrarPagina('inicioContainer'); toggleMenu();">Início</a>
  <a href="#" onclick="mostrarPagina('cadastroContainer'); toggleMenu();">Cadastro</a>
  <a href="#" onclick="mostrarPagina('historicoContainer'); toggleMenu();">Histórico</a>
  <a href="#" onclick="limparTudo(); toggleMenu();">Limpar Dados</a>
</div>

<div id="overlay" onclick="fecharPopup()"></div>
<div id="popupCard">
  <button class="fecharBtn" onclick="fecharPopup()">×</button>
  <div id="popupConteudo"></div>
</div>

<div id="inicioContainer">
  <h1>Controle de Placas</h1>
  <p>Digite a placa para verificar:</p>
  <input type="text" id="placaInput" placeholder="Ex: ABC1234" oninput="this.value = this.value.toUpperCase()">
  <button onclick="verificarPlaca()">Verificar</button>
  <div id="mensagem"></div>
  <h2>Placas em andamento</h2>
  <table>
    <thead>
      <tr>
        <th>Placa</th>
        <th>Nome</th>
        <th>Entrada</th>
        <th>Saída</th>
      </tr>
    </thead>
    <tbody id="tabelaAndamento"></tbody>
  </table>
</div>

<div id="cadastroContainer">
  <h2>Cadastros</h2>
  <div id="listaCadastros" class="lista"></div>
</div>

<div id="historicoContainer">
  <h2>Histórico</h2>
  <label for="dataFiltro">Selecionar data:</label>
  <input type="date" id="dataFiltro">
  <button onclick="filtrarHistorico()">Buscar</button>
  <button id="exportBtn" onclick="exportarCSV()">Exportar CSV</button>
  <div id="listaHistorico" class="lista"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBBbgbO2Mwqbmg8Hq7Kc_Mk1ywAeHeqUkw",
  authDomain: "rnp1-9ba04.firebaseapp.com",
  projectId: "rnp1-9ba04",
  storageBucket: "rnp1-9ba04.appspot.com",
  messagingSenderId: "872258932358",
  appId: "1:872258932358:web:a7a91d77bb6f80123b4b07"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let bancoCadastros = [];
let bancoHistorico = [];

// ====== FUNÇÕES FIRESTORE ======
async function salvarCadastro(cadastro) {
  await addDoc(collection(db, "cadastros"), cadastro);
}

async function salvarHistorico(historico) {
  await addDoc(collection(db, "historico"), historico);
}

async function atualizarDadosLocais() {
  const cadastrosSnap = await getDocs(collection(db, "cadastros"));
  bancoCadastros = cadastrosSnap.docs.map(doc => doc.data());

  const historicoSnap = await getDocs(collection(db, "historico"));
  bancoHistorico = historicoSnap.docs.map(doc => doc.data());

  atualizarCadastros();
  atualizarTabelaAndamento();
}

// Atualização em tempo real
onSnapshot(collection(db, "cadastros"), () => atualizarDadosLocais());
onSnapshot(collection(db, "historico"), () => atualizarDadosLocais());

// ====== FUNÇÕES DE INTERFACE ======
function toggleMenu() { document.getElementById("menu").classList.toggle("menu-open"); }
function mostrarPagina(paginaId) {
  document.getElementById("inicioContainer").style.display = "none";
  document.getElementById("cadastroContainer").style.display = "none";
  document.getElementById("historicoContainer").style.display = "none";
  document.getElementById(paginaId).style.display = "block";
  if(paginaId==='historicoContainer' && !document.getElementById("dataFiltro").value){
    const hoje = new Date();
    document.getElementById("dataFiltro").value = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}-${String(hoje.getDate()).padStart(2,'0')}`;
    filtrarHistorico();
  }
}

function mostrarPopup(conteudo) {
  document.getElementById("popupConteudo").innerHTML = conteudo;
  document.getElementById("overlay").style.display = "block";
  document.getElementById("popupCard").style.display = "block";
}

function fecharPopup() {
  document.getElementById("overlay").style.display = "none";
  document.getElementById("popupCard").style.display = "none";
}

// ====== FUNÇÕES DE CADASTRO/ENTRADA/SAÍDA ======
async function entradaNovaPlaca(placa) {
  const nome = document.getElementById("nomeInput").value;
  const rgcpf = document.getElementById("rgcpfInput").value;
  const tipo = document.getElementById("tipoInput").value;
  if (!nome || !rgcpf || !tipo || !placa) { alert("Preencha todos os campos!"); return; }

  const hoje = new Date();
  const cadastro = { nome, placa, rgcpf, tipo };
  const historico = { ...cadastro, status: "Em andamento", data: hoje.toLocaleDateString(), horarioEntrada: hoje.toLocaleTimeString(), horarioSaida: "" };

  await salvarCadastro(cadastro);
  await salvarHistorico(historico);

  fecharPopup();
  alert("Entrada registrada com sucesso!");
}

async function marcarEntrada(placa) {
  const cadastro = bancoCadastros.find(c => c.placa === placa);
  if(!cadastro){ alert("Placa não cadastrada!"); return; }
  const ultimo = bancoHistorico.filter(h => h.placa === placa).reverse()[0];
  if(ultimo && ultimo.status==="Em andamento"){ alert("Placa já está em andamento!"); return; }

  const hoje = new Date();
  await salvarHistorico({ ...cadastro, status:"Em andamento", data: hoje.toLocaleDateString(), horarioEntrada: hoje.toLocaleTimeString(), horarioSaida:"" });
  fecharPopup();
}

async function marcarSaida(placa) {
  const ultimo = bancoHistorico.filter(h => h.placa === placa && h.status==="Em andamento").reverse()[0];
  if(!ultimo){ alert("Nenhuma entrada em andamento!"); return; }
  ultimo.status = "Finalizado";
  ultimo.horarioSaida = new Date().toLocaleTimeString();
  await salvarHistorico(ultimo);
  document.getElementById("mensagem").innerHTML = "Saída registrada com sucesso!";
  setTimeout(()=>document.getElementById("mensagem").innerHTML="",5000);
  fecharPopup();
}

// ====== FUNÇÕES DE INTERFACE ======
function atualizarCadastros() {
  const listaDiv = document.getElementById("listaCadastros");
  listaDiv.innerHTML = "";
  bancoCadastros.forEach(item => {
    listaDiv.innerHTML += `<div class="item"><b>${item.placa}</b> - ${item.nome} [${item.tipo}] - RG/CPF: ${item.rgcpf}</div>`;
  });
}

function atualizarTabelaAndamento() {
  const tbody = document.getElementById("tabelaAndamento");
  tbody.innerHTML = "";
  bancoHistorico.filter(h=>h.status==="Em andamento").forEach(h=>{
    tbody.innerHTML += `<tr>
      <td>${h.placa}</td>
      <td>${h.nome}</td>
      <td class="horaEntrada">${h.horarioEntrada}</td>
      <td><button class="saida" onclick="marcarSaida('${h.placa}')">Saída</button></td>
    </tr>`;
  });
}

// Histórico
function filtrarHistorico() {
  const input = document.getElementById("dataFiltro").value;
  const dataFiltro = input ? new Date(input).toLocaleDateString() : new Date().toLocaleDateString();
  const listaDiv = document.getElementById("listaHistorico");
  listaDiv.innerHTML = "";

  bancoHistorico.filter(h=>h.data===dataFiltro).forEach(item=>{
    listaDiv.innerHTML += `<div class="item">
      <b>${item.placa}</b> - ${item.nome} [${item.tipo}] - RG/CPF: ${item.rgcpf} <br>
      Data: ${item.data} <br>
      Status: <span style="color:${item.status==="Em andamento"?"red":"green"}">${item.status}</span> <br>
      Entrada: <span class="horaEntrada">${item.horarioEntrada || "-"}</span> | 
      Saída: <span class="horaSaida">${item.horarioSaida || "-"}</span>
    </div>`;
  });
}

// Export CSV
function exportarCSV() {
  const dataFiltro = document.getElementById("dataFiltro").value;
  const dataTexto = dataFiltro ? new Date(dataFiltro).toLocaleDateString() : new Date().toLocaleDateString();
  const filtered = bancoHistorico.filter(item=>item.data===dataTexto);
  if(filtered.length===0){ alert("Nenhum dado para exportar."); return; }

  let csv = "Placa,Nome,Tipo,RG/CPF,Data,Status,Entrada,Saída\n";
  filtered.forEach(item=>{
    csv += `${item.placa},${item.nome},${item.tipo},${item.rgcpf},${item.data},${item.status},${item.horarioEntrada || '-'},${item.horarioSaida || '-'}\n`;
  });

  const blob = new Blob([csv], { type:'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `historico-${dataTexto}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  alert("Exportado com sucesso!");
}

// Limpar dados (Firestore não será limpo aqui, apenas interface)
function limparTudo() {
  if(confirm("Deseja realmente limpar todos os dados locais?")) {
    bancoCadastros=[];
    bancoHistorico=[];
    atualizarCadastros();
    atualizarTabelaAndamento();
    document.getElementById("mensagem").innerHTML = "";
    alert("Dados locais limpos! Para resetar Firestore, faça manualmente.");
  }
}

// Verificar placa
function verificarPlaca() {
  const placa = document.getElementById("placaInput").value.toUpperCase();
  const registro = bancoCadastros.find(c=>c.placa===placa);
  if(registro){
    mostrarPopup(`
      <h3>Placa encontrada ✅</h3>
      <p><b>Placa:</b> ${placa}</p>
      <p><b>Nome:</b> ${registro.nome}</p>
      <p><b>Tipo:</b> ${registro.tipo}</p>
      <p><b>RG/CPF:</b> ${registro.rgcpf}</p>
      <button class="entrada" onclick="marcarEntrada('${placa}')">Entrada</button>
      <button class="saida" onclick="marcarSaida('${placa}')">Saída</button>
    `);
  }else{
    mostrarPopup(`
      <h3>Placa não registrada ⚠️</h3>
      <p><b>Placa:</b> ${placa}</p>
      <input type="text" id="nomeInput" placeholder="Nome">
      <input type="text" id="rgcpfInput" placeholder="RG/CPF">
      <select id="tipoInput">
        <option value="" disabled selected>Tipo:</option>
        <option value="Despacho">Despacho</option>
        <option value="Retiro">Retiro</option>
      </select>
      <button class="entrada" onclick="entradaNovaPlaca('${placa}')">Entrada</button>
    `);
  }
}

// Inicialização
mostrarPagina('inicioContainer');
atualizarDadosLocais();

</script>
</body>
</html>